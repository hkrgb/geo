<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoGuide - 免費地理助手</title>
    
    <!-- 1. 載入樣式與圖標 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. 設定 Tailwind 主題 -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              glass: 'rgba(255, 255, 255, 0.1)',
            },
            animation: {
              'spin-slow': 'spin 3s linear infinite',
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>

    <!-- 3. 自定義 CSS -->
    <style>
      body {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        color: white;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .hidden { display: none !important; }
      
      /* 指南針動畫 */
      .compass-arrow {
        transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
</head>
<body class="pb-10 relative">

    <!-- 背景裝飾 -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-10 left-10 w-72 h-72 bg-emerald-600 rounded-full mix-blend-screen filter blur-[100px] opacity-20 animate-pulse"></div>
        <div class="absolute bottom-10 right-10 w-72 h-72 bg-blue-600 rounded-full mix-blend-screen filter blur-[100px] opacity-20 animate-pulse" style="animation-delay: 1s;"></div>
    </div>

    <div class="max-w-md mx-auto min-h-screen">
        <!-- 標頭 -->
        <header class="p-6 pb-2 flex justify-between items-center">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-200 to-cyan-200">
                <i class="fas fa-location-arrow mr-2 text-white"></i>GeoGuide
            </h1>
            <button id="refreshBtn" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/20 transition active:scale-95 text-white">
                <i class="fas fa-sync-alt"></i>
            </button>
        </header>

        <main class="p-6 pt-2">
            
            <!-- 錯誤訊息 -->
            <div id="errorBox" class="hidden bg-red-500/20 border border-red-500/50 p-4 rounded-xl text-red-100 mb-6 text-sm">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText">發生錯誤</span>
            </div>

            <!-- 初始狀態 -->
            <div id="initialState" class="text-center text-gray-400 py-20">
                <div class="relative w-24 h-24 mx-auto mb-6">
                    <div class="absolute inset-0 bg-white/5 rounded-full animate-ping"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-4xl border border-white/10 rounded-full glass-panel">
                        <i class="fas fa-map-pin text-emerald-400"></i>
                    </div>
                </div>
                <h2 class="text-xl text-white font-medium mb-2">探索您周圍的世界</h2>
                <p class="text-sm opacity-70">點擊右上角按鈕<br>無需設定，立即獲取即時資訊</p>
            </div>

            <!-- 載入中動畫 -->
            <div id="loadingState" class="hidden flex flex-col items-center justify-center h-64 space-y-4">
                <div class="w-12 h-12 border-4 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-emerald-200 animate-pulse text-sm tracking-widest">正在連接衛星數據...</p>
            </div>

            <!-- 結果顯示區 -->
            <div id="resultContainer" class="hidden animate-fade-in-up space-y-6">
                
                <!-- 1. 地點資訊 (Nominatim) -->
                <div class="text-center py-4">
                    <div class="inline-flex items-center space-x-2 px-3 py-1 rounded-full bg-black/20 text-emerald-300 text-xs mb-3 border border-emerald-500/20">
                        <i class="fas fa-crosshairs animate-pulse"></i>
                        <span id="coordsDisplay">--</span>
                    </div>
                    <h2 id="locationName" class="text-3xl font-bold text-white leading-tight mb-2 drop-shadow-lg">
                        定位中...
                    </h2>
                    <p id="addressStr" class="text-gray-400 text-sm px-4">--</p>
                </div>

                <!-- 2. 天氣卡片 (Open-Meteo) -->
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">CURRENT WEATHER</div>
                            <div class="flex items-baseline">
                                <span id="weatherTemp" class="text-6xl font-bold">--</span>
                                <span class="text-2xl ml-1 text-gray-300">°C</span>
                            </div>
                            <div id="weatherCond" class="text-lg text-emerald-300 font-medium mt-1 flex items-center">
                                --
                            </div>
                        </div>
                        <div class="text-right">
                             <i id="weatherIcon" class="fas fa-cloud text-6xl text-gray-300/50"></i>
                        </div>
                    </div>

                    <!-- 風速儀表板 -->
                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <div class="bg-black/20 rounded-xl p-3 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-300">
                                <i class="fas fa-wind text-sm"></i>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase">風速</div>
                                <div class="font-bold text-sm"><span id="windSpeed">--</span> <span class="text-xs font-normal opacity-70">km/h</span></div>
                            </div>
                        </div>
                        <div class="bg-black/20 rounded-xl p-3 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-300 relative">
                                <i id="windDirIcon" class="fas fa-location-arrow text-sm compass-arrow"></i>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase">風向</div>
                                <div id="windDirText" class="font-bold text-sm">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 附近景點列表 (Wikipedia) -->
                <div>
                    <h3 class="text-lg font-bold flex items-center mb-4 px-1">
                        <i class="fab fa-wikipedia-w mr-2 text-gray-400"></i>
                        附近地標與景點
                    </h3>
                    <div id="attractionsList" class="space-y-3">
                        <!-- JS 動態插入 -->
                    </div>
                </div>

                <!-- 資料來源 -->
                <div class="text-center text-[10px] text-gray-600 pt-8 pb-4">
                    Data provided by <a href="https://www.openstreetmap.org/" class="underline hover:text-gray-400">OpenStreetMap</a>, 
                    <a href="https://open-meteo.com/" class="underline hover:text-gray-400">Open-Meteo</a> & 
                    <a href="https://www.wikipedia.org/" class="underline hover:text-gray-400">Wikipedia</a>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM 元素
        const els = {
            refreshBtn: document.getElementById('refreshBtn'),
            initialState: document.getElementById('initialState'),
            loadingState: document.getElementById('loadingState'),
            resultContainer: document.getElementById('resultContainer'),
            errorBox: document.getElementById('errorBox'),
            errorText: document.getElementById('errorText'),
            // 數據顯示
            coordsDisplay: document.getElementById('coordsDisplay'),
            locationName: document.getElementById('locationName'),
            addressStr: document.getElementById('addressStr'),
            weatherTemp: document.getElementById('weatherTemp'),
            weatherCond: document.getElementById('weatherCond'),
            weatherIcon: document.getElementById('weatherIcon'),
            windSpeed: document.getElementById('windSpeed'),
            windDirText: document.getElementById('windDirText'),
            windDirIcon: document.getElementById('windDirIcon'),
            attractionsList: document.getElementById('attractionsList')
        };

        // 事件監聽
        els.refreshBtn.addEventListener('click', startProcess);

        // 天氣代碼對照表 (WMO Code -> 中文)
        const weatherCodes = {
            0: { text: "晴朗", icon: "fa-sun" },
            1: { text: "大致晴朗", icon: "fa-cloud-sun" },
            2: { text: "多雲", icon: "fa-cloud" },
            3: { text: "陰天", icon: "fa-cloud" },
            45: { text: "有霧", icon: "fa-smog" },
            48: { text: "霧淞", icon: "fa-smog" },
            51: { text: "毛毛雨", icon: "fa-cloud-rain" },
            53: { text: "小雨", icon: "fa-cloud-rain" },
            55: { text: "中雨", icon: "fa-cloud-showers-heavy" },
            61: { text: "小雨", icon: "fa-cloud-rain" },
            63: { text: "下雨", icon: "fa-cloud-showers-heavy" },
            65: { text: "大雨", icon: "fa-cloud-showers-heavy" },
            80: { text: "雷陣雨", icon: "fa-bolt" },
            95: { text: "雷雨", icon: "fa-bolt" },
            96: { text: "雷暴", icon: "fa-bolt" },
            99: { text: "強烈雷暴", icon: "fa-bolt" }
        };

        function startProcess() {
            if (!navigator.geolocation) {
                showError("您的瀏覽器不支援地理定位");
                return;
            }

            setLoading(true);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    els.coordsDisplay.innerText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    
                    // 平行執行所有請求
                    Promise.all([
                        fetchAddress(lat, lon),
                        fetchWeather(lat, lon),
                        fetchAttractions(lat, lon)
                    ]).then(() => {
                        setLoading(false);
                        els.initialState.classList.add('hidden');
                        els.resultContainer.classList.remove('hidden');
                    }).catch(err => {
                        console.error(err);
                        showError("獲取部分數據失敗，請檢查網路連接");
                        setLoading(false);
                    });
                },
                (err) => {
                    setLoading(false);
                    showError("無法獲取位置: " + err.message);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // 1. 獲取地址 (OpenStreetMap Nominatim)
        async function fetchAddress(lat, lon) {
            try {
                // 使用 fetch 獲取數據
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-HK`);
                const data = await res.json();
                
                // 智能顯示地名邏輯
                const addr = data.address || {};
                const city = addr.city || addr.town || addr.district || addr.county || "";
                const suburb = addr.suburb || addr.neighbourhood || "";
                const road = addr.road || "";
                const building = addr.building || addr.amenity || addr.tourism || "";

                // 組合主要名稱
                let mainName = building || road || suburb;
                if (!mainName) mainName = "未知位置";

                // 組合詳細地址
                const fullAddress = data.display_name || "";

                els.locationName.innerText = mainName;
                els.addressStr.innerText = city + (suburb ? `，${suburb}` : "") + (road ? `，${road}` : "");

            } catch (e) {
                els.locationName.innerText = "位置資訊不可用";
            }
        }

        // 2. 獲取天氣 (Open-Meteo)
        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m&wind_speed_unit=kmh`);
                const data = await res.json();
                const current = data.current;

                if (current) {
                    els.weatherTemp.innerText = Math.round(current.temperature_2m);
                    els.windSpeed.innerText = current.wind_speed_10m;
                    
                    // 風向
                    const deg = current.wind_direction_10m;
                    els.windDirIcon.style.transform = `rotate(${deg - 45}deg)`; // -45 是因為圖示本身指向右上
                    els.windDirText.innerText = getWindDirectionText(deg);

                    // 天氣狀況
                    const code = current.weather_code;
                    const weatherInfo = weatherCodes[code] || { text: "未知", icon: "fa-question" };
                    els.weatherCond.innerHTML = `<i class="fas ${weatherInfo.icon} mr-2"></i> ${weatherInfo.text}`;
                    els.weatherIcon.className = `fas ${weatherInfo.icon} text-6xl text-emerald-100`;
                }
            } catch (e) {
                els.weatherCond.innerText = "天氣數據不可用";
            }
        }

        // 3. 獲取附近維基百科條目 (Wikipedia API)
        async function fetchAttractions(lat, lon) {
            try {
                // 搜索半徑 2000米, 上限 10 個
                const res = await fetch(`https://zh.wikipedia.org/w/api.php?origin=*&action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=2000&gslimit=10&format=json`);
                const data = await res.json();
                const places = data.query?.geosearch || [];

                els.attractionsList.innerHTML = '';

                if (places.length === 0) {
                    els.attractionsList.innerHTML = '<p class="text-gray-400 text-center text-sm">附近沒有找到維基百科條目</p>';
                    return;
                }

                places.forEach(place => {
                    const bearing = calculateBearing(lat, lon, place.lat, place.lon);
                    const directionText = getCardinalDirection(bearing);
                    
                    const html = `
                    <div class="glass-panel p-3 rounded-xl border border-white/5 flex items-center justify-between group hover:bg-white/10 transition-all cursor-pointer" onclick="window.open('https://zh.wikipedia.org/?curid=${place.pageid}', '_blank')">
                        <div class="flex-1 min-w-0 pr-4">
                            <h4 class="font-bold text-white truncate group-hover:text-emerald-300 transition-colors">${place.title}</h4>
                            <div class="flex items-center text-xs text-gray-400 mt-1 space-x-2">
                                <span class="bg-white/10 px-1.5 py-0.5 rounded text-[10px]">${place.dist.toFixed(0)}m</span>
                                <span><i class="fas fa-location-arrow text-[10px] transform rotate-[${bearing}deg]"></i> ${directionText}</span>
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 group-hover:bg-emerald-500 group-hover:text-white transition-all">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </div>
                    </div>
                    `;
                    els.attractionsList.innerHTML += html;
                });

            } catch (e) {
                console.error(e);
                els.attractionsList.innerHTML = '<p class="text-red-300 text-sm">無法獲取景點資訊</p>';
            }
        }

        // 工具函式：計算方位角
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = x => x * Math.PI / 180;
            const toDeg = x => x * 180 / Math.PI;
            
            const dLon = toRad(lon2 - lon1);
            const y = Math.sin(dLon) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
            
            let brng = toDeg(Math.atan2(y, x));
            return (brng + 360) % 360;
        }

        // 工具函式：方位角轉文字
        function getCardinalDirection(angle) {
            const directions = ['北', '東北', '東', '東南', '南', '西南', '西', '西北'];
            return directions[Math.round(angle / 45) % 8];
        }

        // 工具函式：風向角度轉文字
        function getWindDirectionText(degree) {
            const sectors = ["北", "東北", "東", "東南", "南", "西南", "西", "西北"];
            degree += 22.5;
            if (degree < 0) degree = 360 - Math.abs(degree) % 360;
            else degree = degree % 360;
            const index = Math.floor(degree / 45);
            return sectors[index];
        }

        function setLoading(loading) {
            els.errorBox.classList.add('hidden');
            if (loading) {
                els.refreshBtn.classList.add('animate-spin');
                els.loadingState.classList.remove('hidden');
                els.initialState.classList.add('hidden');
                els.resultContainer.classList.add('hidden');
            } else {
                els.refreshBtn.classList.remove('animate-spin');
                els.loadingState.classList.add('hidden');
            }
        }

        function showError(msg) {
            els.errorText.innerText = msg;
            els.errorBox.classList.remove('hidden');
            els.initialState.classList.remove('hidden');
        }
    </script>
</body>
</html>